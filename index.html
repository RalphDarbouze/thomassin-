<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUBIS TV 2026 - Advanced Buffering Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }
        
        :root {
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #a5b4fc;
            --secondary-color: #10b981;
            --accent-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-bg: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --gradient-accent: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.2);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        html, body {
            width: 100%;
            height: 100%;
            background: var(--dark-bg);
            overflow: hidden;
            color: var(--text-primary);
        }
        
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100vh;
            background: var(--dark-bg);
            backdrop-filter: blur(10px);
        }
        
        /* Top Bar - Modern Glass Effect */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            z-index: 100;
            height: 64px;
            box-shadow: var(--shadow-md);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-icon {
            color: var(--primary-color);
            font-size: 24px;
            filter: drop-shadow(0 0 8px rgba(99, 102, 241, 0.3));
        }
        
        .logo-text {
            font-size: 20px;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }
        
        .logo-year {
            color: var(--accent-color);
            font-weight: 600;
        }
        
        .top-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        /* Network Status in Top Bar - Glass Card */
        .network-status {
            background: var(--glass-bg);
            border-radius: 12px;
            padding: 8px 16px;
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .network-status:hover {
            border-color: var(--primary-light);
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.2);
        }
        
        .network-icon {
            font-size: 14px;
            color: var(--secondary-color);
        }
        
        .network-text {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .network-speed {
            color: var(--secondary-color);
            font-weight: 600;
            font-size: 13px;
        }
        
        /* Buffer Control in Top Bar */
        .buffer-control {
            background: var(--glass-bg);
            border-radius: 12px;
            padding: 8px 16px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
        }
        
        .buffer-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 6px;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        
        .buffer-buttons {
            display: flex;
            gap: 6px;
        }
        
        .buffer-btn {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            min-width: 45px;
        }
        
        .buffer-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }
        
        .buffer-btn.active {
            background: var(--gradient-primary);
            border-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .current-time {
            background: var(--glass-bg);
            border-radius: 12px;
            padding: 8px 16px;
            border: 1px solid var(--glass-border);
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            backdrop-filter: blur(10px);
            min-width: 85px;
            text-align: center;
        }
        
        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        /* Channel List Sidebar - Glass Panel */
        .channel-sidebar {
            width: 300px;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            z-index: 10;
            transition: transform 0.3s ease;
            box-shadow: var(--shadow-lg);
        }
        
        .channel-sidebar.hidden {
            transform: translateX(-300px);
        }
        
        .channel-list-header {
            padding: 20px;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .channel-list-header h2 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .search-box {
            position: relative;
            margin-bottom: 12px;
        }
        
        .search-box i {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 14px;
            z-index: 2;
        }
        
        #channel-search {
            width: 100%;
            padding: 12px 12px 12px 42px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        #channel-search:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .channel-list-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        
        .channel-category {
            margin-bottom: 20px;
        }
        
        .category-title {
            font-size: 13px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 12px;
            padding-left: 12px;
            font-weight: 600;
        }
        
        .channel-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            margin: 4px 0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--glass-bg);
            border: 1px solid transparent;
            backdrop-filter: blur(10px);
        }
        
        .channel-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--glass-border);
            transform: translateX(4px);
        }
        
        .channel-item.active {
            background: rgba(99, 102, 241, 0.15);
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }
        
        .channel-item:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
        
        .channel-logo {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 14px;
            flex-shrink: 0;
            font-size: 14px;
            font-weight: 700;
            color: white;
            box-shadow: var(--shadow-sm);
        }
        
        .channel-info {
            flex: 1;
            min-width: 0;
        }
        
        .channel-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-primary);
        }
        
        .channel-number {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 500;
        }
        
        .channel-playing {
            color: var(--secondary-color);
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .channel-item.active .channel-playing {
            opacity: 1;
        }
        
        /* Video Player Area */
        .player-area {
            flex: 1;
            position: relative;
            background: #000;
        }
        
        #video-player {
            width: 100%;
            height: 100%;
            object-fit: contain;
            outline: none;
            background: #000;
        }
        
        /* Fullscreen Button - Floating Glass */
        .fullscreen-btn {
            position: absolute;
            bottom: 24px;
            right: 24px;
            z-index: 50;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-lg);
        }
        
        .fullscreen-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(1.1) translateY(-2px);
            border-color: var(--primary-color);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }
        
        .fullscreen-btn .fullscreen-in {
            display: block;
        }
        
        .fullscreen-btn .fullscreen-out {
            display: none;
        }
        
        /* Live Viewer Counter - Glass Card */
        .viewer-counter {
            position: absolute;
            bottom: 24px;
            right: 96px;
            z-index: 50;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 20px;
            padding: 10px 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            display: flex;
        }
        
        .viewer-counter:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            border-color: var(--secondary-color);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.2);
        }
        
        .viewer-counter i {
            color: var(--secondary-color);
            font-size: 16px;
        }
        
        .viewer-counter span {
            color: white;
            font-weight: 700;
            min-width: 40px;
            text-align: center;
            font-size: 15px;
        }
        
        .viewer-counter .connection-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 8px;
        }
        
        .viewer-counter .status-connected {
            background-color: var(--secondary-color);
            box-shadow: 0 0 10px var(--secondary-color);
        }
        
        .viewer-counter .status-connecting {
            background-color: var(--accent-color);
            animation: pulse 1.5s infinite;
        }
        
        .viewer-counter .status-disconnected {
            background-color: var(--danger-color);
        }
        
        /* Advanced Buffering Overlay - Glass Effect */
        .buffering-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(30px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .buffering-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .buffering-spinner {
            width: 70px;
            height: 70px;
            border: 4px solid rgba(99, 102, 241, 0.2);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 24px;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
        }
        
        .buffering-text {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            text-align: center;
        }
        
        .buffering-progress {
            width: 320px;
            height: 8px;
            background: var(--glass-bg);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 20px;
            border: 1px solid var(--glass-border);
        }
        
        .buffering-progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .buffering-timer {
            font-size: 14px;
            color: var(--text-muted);
            margin-top: 12px;
            font-weight: 500;
        }
        
        .buffer-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            padding: 16px 24px;
            margin-top: 24px;
            max-width: 420px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .buffer-warning h4 {
            color: var(--accent-color);
            margin-bottom: 8px;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .buffer-warning p {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        /* Buffer Stats Display - Glass Card */
        .buffer-stats-display {
            position: absolute;
            top: 24px;
            right: 24px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            min-width: 220px;
            z-index: 15;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-lg);
            display: none; /* Hidden by default */
        }
        
        .buffer-stats-title {
            font-size: 13px;
            color: var(--primary-color);
            margin-bottom: 12px;
            font-weight: 700;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .buffer-stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .buffer-stat-label {
            color: var(--text-muted);
            font-weight: 500;
        }
        
        .buffer-stat-value {
            color: var(--text-primary);
            font-weight: 600;
        }
        
        /* Player Overlay */
        .player-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: 10;
        }
        
        .player-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        
        /* Channel Info Overlay - Glass Effect */
        .channel-info-overlay {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(20px);
            padding: 16px 24px;
            max-width: 420px;
            border-radius: 0 0 12px 0;
            border-bottom: 2px solid var(--primary-color);
            transform: translateY(-100%);
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            margin-top: 12px;
            margin-left: 12px;
            font-weight: 500;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-md);
        }
        
        .player-overlay.active .channel-info-overlay {
            transform: translateY(0);
            opacity: 1;
        }
        
        .current-channel-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--text-primary);
        }
        
        .current-channel-group {
            font-size: 12px;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        /* Player Controls - Glass Effect */
        .player-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(20px);
            padding: 16px 24px;
            border-radius: 16px;
            margin: 0 auto 24px;
            transform: translateY(100%);
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-lg);
            gap: 24px;
        }
        
        .player-overlay.active .player-controls {
            transform: translateY(0);
            opacity: 1;
        }
        
        .control-buttons {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .control-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .control-btn:hover, .control-btn:focus {
            background: rgba(99, 102, 241, 0.3);
            transform: scale(1.05) translateY(-2px);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .control-btn.play-pause {
            background: var(--gradient-primary);
            width: 52px;
            height: 52px;
            font-size: 18px;
            border: none;
        }
        
        .control-btn.play-pause:hover {
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
            transform: scale(1.1) translateY(-2px);
        }
        
        .control-btn.buffer-btn {
            background: rgba(16, 185, 129, 0.3);
            border-color: rgba(16, 185, 129, 0.5);
        }
        
        .control-btn.buffer-btn:hover {
            background: rgba(16, 185, 129, 0.5);
            border-color: var(--secondary-color);
        }
        
        .volume-control {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 120px;
        }
        
        .volume-slider {
            width: 90px;
            height: 4px;
            background: var(--glass-bg);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }
        
        .volume-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 10px var(--primary-color);
        }
        
        .volume-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: var(--shadow-sm);
        }
        
        .volume-icon {
            font-size: 16px;
            color: var(--text-primary);
            min-width: 24px;
        }
        
        .time-display {
            color: var(--text-secondary);
            font-size: 13px;
            min-width: 80px;
            text-align: center;
            font-weight: 500;
        }
        
        /* Info Panel - Glass Effect */
        .info-panel {
            width: 320px;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(20px);
            border-left: 1px solid var(--glass-border);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 10;
            transition: transform 0.3s ease;
            box-shadow: var(--shadow-lg);
        }
        
        .info-panel.hidden {
            transform: translateX(320px);
        }
        
        .panel-section {
            background: var(--glass-bg);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
        }
        
        .panel-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .now-playing-info {
            text-align: center;
        }
        
        .now-playing-logo {
            width: 70px;
            height: 70px;
            border-radius: 16px;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-size: 20px;
            color: white;
            font-weight: 700;
            box-shadow: var(--shadow-md);
        }
        
        .now-playing-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--text-primary);
        }
        
        .now-playing-group {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 16px;
            font-weight: 500;
        }
        
        /* Buffer Stats */
        .buffer-stats {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--glass-border);
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .stat-label {
            color: var(--text-muted);
            font-weight: 500;
        }
        
        .stat-value {
            color: var(--text-primary);
            font-weight: 600;
        }
        
        /* Progress bar */
        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            z-index: 5;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            width: 0%;
            transition: width 0.1s;
        }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(30px);
        }
        
        .loading-screen .buffering-spinner {
            width: 80px;
            height: 80px;
            border-width: 5px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Custom Scrollbar */
        .channel-list-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .channel-list-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 3px;
        }
        
        .channel-list-container::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.3);
            border-radius: 3px;
        }
        
        .channel-list-container::-webkit-scrollbar-thumb:hover {
            background: rgba(99, 102, 241, 0.5);
        }
        
        /* TV Focus styles */
        *:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 4px;
            border-radius: 4px;
        }
        
        /* Fullscreen Mode Styles - FIXED */
        body.fullscreen-mode {
            overflow: hidden !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        
        body.fullscreen-mode .app-container {
            background: #000 !important;
            width: 100vw !important;
            height: 100vh !important;
            max-width: 100vw !important;
            max-height: 100vh !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
        }
        
        body.fullscreen-mode .top-bar,
        body.fullscreen-mode .channel-sidebar,
        body.fullscreen-mode .info-panel {
            display: none !important;
        }
        
        body.fullscreen-mode .player-area {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999 !important;
        }
        
        body.fullscreen-mode #video-player {
            object-fit: contain !important;
            width: 100% !important;
            height: 100% !important;
            display: block !important;
            background: #000 !important;
        }
        
        body.fullscreen-mode .fullscreen-btn {
            bottom: 30px !important;
            right: 30px !important;
            background: rgba(255, 255, 255, 0.15) !important;
            width: 60px !important;
            height: 60px !important;
            font-size: 22px !important;
        }
        
        body.fullscreen-mode .fullscreen-btn:hover {
            transform: scale(1.15) translateY(-2px) !important;
        }
        
        body.fullscreen-mode .fullscreen-btn .fullscreen-in {
            display: none !important;
        }
        
        body.fullscreen-mode .fullscreen-btn .fullscreen-out {
            display: block !important;
        }
        
        body.fullscreen-mode .viewer-counter {
            bottom: 30px !important;
            right: 110px !important;
            background: rgba(255, 255, 255, 0.15) !important;
            padding: 12px 20px !important;
            font-size: 15px !important;
        }
        
        body.fullscreen-mode .viewer-counter i {
            font-size: 18px !important;
        }
        
        /* Fullscreen button icons */
        .fullscreen-btn .fullscreen-out {
            display: none;
        }
        
        /* In fullscreen mode, make overlay even more transparent */
        body.fullscreen-mode .channel-info-overlay {
            background: rgba(15, 23, 42, 0.6);
            padding: 12px 20px;
            margin-top: 20px;
            margin-left: 20px;
        }
        
        body.fullscreen-mode .player-controls {
            background: rgba(15, 23, 42, 0.6);
            padding: 14px 20px;
            margin-bottom: 20px;
        }
        
        body.fullscreen-mode .buffer-stats-display {
            top: 20px !important;
            right: 20px !important;
        }
        
        /* Ensure no borders on mobile/desktop */
        @media (display-mode: fullscreen) {
            body.fullscreen-mode .player-area {
                width: 100vw !important;
                height: 100vh !important;
            }
            
            body.fullscreen-mode #video-player {
                object-fit: contain !important;
            }
        }
        
        /* Live Event Notification */
        .live-event-notification {
            position: absolute;
            top: 80px;
            right: 20px;
            background: rgba(16, 185, 129, 0.9);
            backdrop-filter: blur(20px);
            border-left: 4px solid var(--accent-color);
            border-radius: 12px;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            z-index: 60;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.5s ease-out;
            max-width: 320px;
        }
        
        .live-event-notification i {
            color: var(--accent-color);
            font-size: 18px;
        }
        
        .live-event-notification.fade-out {
            opacity: 0;
            transform: translateX(100px);
            transition: all 0.5s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* Counting animation */
        .viewer-counter .counting {
            animation: countPulse 0.5s ease;
            color: var(--accent-color);
        }
        
        @keyframes countPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .channel-sidebar {
                width: 280px;
            }
            
            .info-panel {
                width: 300px;
            }
        }
        
        @media (max-width: 1024px) {
            .info-panel {
                display: none;
            }
            
            .top-controls {
                display: none;
            }
        }
        
        @media (max-width: 768px) {
            .channel-sidebar {
                width: 260px;
            }
            
            .player-controls {
                padding: 12px 16px;
                gap: 16px;
            }
            
            .control-btn {
                width: 40px;
                height: 40px;
            }
            
            .control-btn.play-pause {
                width: 46px;
                height: 46px;
            }
            
            /* On mobile, make overlay elements smaller */
            .channel-info-overlay {
                max-width: 320px;
                padding: 12px 16px;
                margin-top: 8px;
                margin-left: 8px;
            }
            
            .current-channel-name {
                font-size: 16px;
            }
            
            .current-channel-group {
                font-size: 11px;
            }
            
            .fullscreen-btn {
                width: 48px;
                height: 48px;
                bottom: 16px;
                right: 16px;
                font-size: 18px;
            }
            
            .viewer-counter {
                bottom: 16px;
                right: 80px;
                padding: 8px 14px;
                font-size: 13px;
            }
            
            .viewer-counter i {
                font-size: 14px;
            }
        }
        
        /* Hide overlay elements after a delay in fullscreen */
        .hide-overlay {
            opacity: 0 !important;
            pointer-events: none !important;
            transition: opacity 0.5s ease;
        }
        
        /* Smooth transitions for interactive elements */
        button, input[type="range"], .channel-item, .buffer-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Glow effects for active states */
        .active-glow {
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="buffering-spinner"></div>
        <div style="text-align: center;">
            <h3 style="margin-bottom: 12px; color: var(--primary-color); font-size: 24px; font-weight: 700;">RUBIS TV 2026</h3>
            <p style="color: var(--text-muted); font-size: 14px;">Initializing Advanced Buffer System...</p>
            <p style="color: var(--text-secondary); font-size: 13px; margin-top: 12px;">10-Second Smart Buffering Enabled</p>
        </div>
    </div>
    
    <!-- Main App Container -->
    <div class="app-container" id="appContainer">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="logo">
                <i class="fas fa-satellite-dish logo-icon"></i>
                <div class="logo-text">RUBIS TV <span class="logo-year">2026</span></div>
            </div>
            
            <!-- Buffer Control in Top Bar -->
            <div class="top-controls">
                <div class="network-status" id="networkStatus">
                    <i class="fas fa-wifi network-icon"></i>
                    <div class="network-text">
                        Speed: <span class="network-speed" id="networkSpeed">Testing...</span>
                    </div>
                </div>
                
                <div class="buffer-control" id="bufferControl">
                    <div class="buffer-label">BUFFER</div>
                    <div class="buffer-buttons">
                        <button class="buffer-btn active" data-buffer="5">5s</button>
                        <button class="buffer-btn" data-buffer="10">10s</button>
                        <button class="buffer-btn" data-buffer="15">15s</button>
                        <button class="buffer-btn" data-buffer="20">20s</button>
                    </div>
                </div>
            </div>
            
            <div class="current-time" id="currentTime">--:--</div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Channel List Sidebar -->
            <div class="channel-sidebar" id="channelSidebar">
                <div class="channel-list-header">
                    <h2><i class="fas fa-list"></i> CHANNELS</h2>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="channel-search" placeholder="Search channels..." autocomplete="off">
                    </div>
                    <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px; font-weight: 500;">
                        <span id="channelCount">0</span> channels loaded
                    </div>
                </div>
                
                <div class="channel-list-container" id="channelList">
                    <!-- Channels will be loaded here -->
                </div>
            </div>
            
            <!-- Video Player Area -->
            <div class="player-area">
                <video id="video-player" playsinline preload="auto" crossorigin="anonymous"></video>
                
                <!-- FIXED FULLSCREEN BUTTON -->
                <button class="fullscreen-btn" id="fullscreenBtn" title="Toggle Fullscreen (F)">
                    <i class="fas fa-expand fullscreen-in"></i>
                    <i class="fas fa-compress fullscreen-out"></i>
                </button>
                
                <!-- LIVE VIEWER COUNTER -->
                <div class="viewer-counter" id="viewerCounter" title="Connecting to viewer server...">
                    <i class="fas fa-users"></i>
                    <span id="viewerCount">0</span>
                    <div class="connection-status status-connecting"></div>
                </div>
                
                <!-- Buffer Stats Display -->
                <div class="buffer-stats-display" id="bufferStats">
                    <div class="buffer-stats-title"><i class="fas fa-battery-full"></i> BUFFER STATUS</div>
                    <div class="buffer-stat-item">
                        <span class="buffer-stat-label">Buffer Time:</span>
                        <span class="buffer-stat-value" id="currentBufferTime">0s</span>
                    </div>
                    <div class="buffer-stat-item">
                        <span class="buffer-stat-label">Buffer Progress:</span>
                        <span class="buffer-stat-value" id="bufferProgress">0%</span>
                    </div>
                    <div class="buffer-stat-item">
                        <span class="buffer-stat-label">Network Speed:</span>
                        <span class="buffer-stat-value" id="liveNetworkSpeed">0 Mbps</span>
                    </div>
                    <div class="buffer-stat-item">
                        <span class="buffer-stat-label">Status:</span>
                        <span class="buffer-stat-value" id="bufferStatus">Idle</span>
                    </div>
                </div>
                
                <!-- Advanced Buffering Overlay -->
                <div class="buffering-overlay" id="bufferingOverlay">
                    <div class="buffering-spinner"></div>
                    <div class="buffering-text" id="bufferingText">Smart Buffering System</div>
                    <div class="buffering-progress">
                        <div class="buffering-progress-fill" id="bufferingProgressFill"></div>
                    </div>
                    <div class="buffering-timer" id="bufferingTimer">Pre-buffering: 0/10s</div>
                    
                    <div class="buffer-warning">
                        <h4><i class="fas fa-shield-alt"></i> Advanced Lag Prevention</h4>
                        <p>10-second pre-buffer ensures smooth playback. System adapts to your network speed automatically.</p>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                
                <!-- Player Overlay -->
                <div class="player-overlay" id="playerOverlay">
                    <!-- Top Info -->
                    <div class="channel-info-overlay">
                        <div class="current-channel-name" id="overlayChannelName">No channel selected</div>
                        <div class="current-channel-group" id="overlayChannelGroup">Select a channel to start watching</div>
                    </div>
                    
                    <!-- Bottom Controls -->
                    <div class="player-controls">
                        <div class="control-buttons">
                            <button class="control-btn" id="prevChannel" title="Previous Channel (Up)">
                                <i class="fas fa-step-backward"></i>
                            </button>
                            <button class="control-btn play-pause" id="playPause" title="Play/Pause (Space)">
                                <i class="fas fa-play" id="playIcon"></i>
                            </button>
                            <button class="control-btn" id="nextChannel" title="Next Channel (Down)">
                                <i class="fas fa-step-forward"></i>
                            </button>
                            <button class="control-btn buffer-btn" id="manualBufferBtn" title="Manual Buffer (B)">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        
                        <div class="volume-control">
                            <i class="fas fa-volume-up volume-icon" id="volumeIcon"></i>
                            <input type="range" class="volume-slider" id="volumeSlider" 
                                   min="0" max="1" step="0.1" value="0.75" title="Volume">
                        </div>
                        
                        <div class="time-display">
                            <span id="currentTimeDisplay">0:00</span> / <span id="durationDisplay">0:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Info Panel -->
            <div class="info-panel" id="infoPanel">
                <!-- Now Playing -->
                <div class="panel-section now-playing-info">
                    <div class="panel-title">
                        <i class="fas fa-broadcast-tower"></i> NOW PLAYING
                    </div>
                    <div class="now-playing-logo" id="nowPlayingLogo">
                        <i class="fas fa-tv"></i>
                    </div>
                    <div class="now-playing-name" id="nowPlayingName">No channel</div>
                    <div class="now-playing-group" id="nowPlayingGroup">--</div>
                    <div style="font-size: 12px; color: var(--text-muted); margin-top: 12px; font-weight: 500;">
                        <i class="fas fa-wifi"></i> Status: <span id="streamStatus" style="color: var(--primary-color);">Idle</span>
                    </div>
                    
                    <div class="buffer-stats">
                        <div class="stat-item">
                            <span class="stat-label">Buffer Size:</span>
                            <span class="stat-value" id="bufferSize">0 MB</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Buffer Time:</span>
                            <span class="stat-value" id="bufferTime">0s</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Bitrate:</span>
                            <span class="stat-value" id="bitrate">0 kbps</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Buffer Mode:</span>
                            <span class="stat-value" id="bufferMode">Adaptive</span>
                        </div>
                    </div>
                </div>
                
                <!-- Performance Info -->
                <div class="panel-section">
                    <div class="panel-title">
                        <i class="fas fa-tachometer-alt"></i> BUFFER PERFORMANCE
                    </div>
                    <div class="buffer-stats">
                        <div class="stat-item">
                            <span class="stat-label">Network Speed:</span>
                            <span class="stat-value" id="performanceSpeed">Testing...</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Target Buffer:</span>
                            <span class="stat-value" id="targetBuffer">10s</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Current Buffer:</span>
                            <span class="stat-value" id="currentBuffer">0s</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Lag Prevention:</span>
                            <span class="stat-value" style="color: var(--secondary-color);">Active</span>
                        </div>
                    </div>
                </div>
                
                <!-- Remote Guide -->
                <div class="panel-section">
                    <div class="panel-title">
                        <i class="fas fa-gamepad"></i> BUFFER CONTROLS
                    </div>
                    <div style="font-size: 13px; color: var(--text-muted); line-height: 1.5;">
                        <p><span style="color: var(--primary-color); font-weight: 600;">B</span> Manual Buffer</p>
                        <p><span style="color: var(--primary-color); font-weight: 600;">1-4</span> Buffer presets</p>
                        <p><span style="color: var(--primary-color); font-weight: 600;">↑↓</span> Navigate channels</p>
                        <p><span style="color: var(--primary-color); font-weight: 600;">SPACE</span> Play/Pause</p>
                        <p><span style="color: var(--primary-color); font-weight: 600;">F</span> Fullscreen</p>
                        <p><span style="color: var(--primary-color); font-weight: 600;">ESC</span> Show/Hide panels</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== REAL LIVE VIEWER COUNTER SYSTEM ====================
        const RealViewerCounter = {
            currentViewers: 0,
            isConnected: false,
            wsConnection: null,
            reconnectAttempts: 0,
            maxReconnectAttempts: 10,
            reconnectDelay: 3000,
            currentChannelId: null,
            sessionId: null,
            heartbeatInterval: null,
            
            // WebSocket server URL (Update this to your server URL)
            // For local development: 'ws://localhost:3000'
            // For production: 'wss://your-domain.com'
            websocketUrl: 'wss://thomassin-production.up.railway.app',
            
            init() {
                console.log('👥 Initializing Real Viewer Counter System');
                this.connectWebSocket();
                
                // Show the counter immediately
                const viewerCounterEl = document.getElementById('viewerCounter');
                viewerCounterEl.style.display = 'flex';
                viewerCounterEl.title = 'Connecting to live viewer server...';
                
                // Update connection status indicator
                this.updateConnectionStatus('connecting');
            },
            
            // Update connection status indicator
            updateConnectionStatus(status) {
                const statusDot = document.querySelector('.viewer-counter .connection-status');
                if (!statusDot) return;
                
                // Remove all status classes
                statusDot.classList.remove('status-connected', 'status-connecting', 'status-disconnected');
                
                // Add new status class
                switch(status) {
                    case 'connected':
                        statusDot.classList.add('status-connected');
                        document.getElementById('viewerCounter').title = 'Live Viewers (Connected)';
                        break;
                    case 'connecting':
                        statusDot.classList.add('status-connecting');
                        document.getElementById('viewerCounter').title = 'Live Viewers (Connecting...)';
                        break;
                    case 'disconnected':
                        statusDot.classList.add('status-disconnected');
                        document.getElementById('viewerCounter').title = 'Live Viewers (Disconnected)';
                        break;
                }
            },
            
            // Connect to WebSocket server
            connectWebSocket() {
                try {
                    console.log(`📡 Connecting to WebSocket server: ${this.websocketUrl}`);
                    this.updateConnectionStatus('connecting');
                    
                    this.wsConnection = new WebSocket(this.websocketUrl);
                    
                    this.wsConnection.onopen = () => {
                        console.log('✅ Connected to live viewer server');
                        this.isConnected = true;
                        this.reconnectAttempts = 0;
                        this.updateConnectionStatus('connected');
                        
                        // If we have a current channel, subscribe to it
                        if (this.currentChannelId) {
                            this.subscribeToChannel(this.currentChannelId);
                        }
                        
                        // Start heartbeat
                        this.startHeartbeat();
                    };
                    
                    this.wsConnection.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.handleServerMessage(data);
                        } catch (error) {
                            console.error('Error parsing server message:', error);
                        }
                    };
                    
                    this.wsConnection.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.isConnected = false;
                        this.updateConnectionStatus('disconnected');
                    };
                    
                    this.wsConnection.onclose = () => {
                        console.log('📡 Disconnected from viewer server');
                        this.isConnected = false;
                        this.updateConnectionStatus('disconnected');
                        
                        // Stop heartbeat
                        if (this.heartbeatInterval) {
                            clearInterval(this.heartbeatInterval);
                        }
                        
                        // Try to reconnect
                        this.attemptReconnect();
                    };
                    
                } catch (error) {
                    console.error('Failed to connect to viewer server:', error);
                    this.attemptReconnect();
                }
            },
            
            // Handle messages from server
            handleServerMessage(data) {
                switch(data.type) {
                    case 'welcome':
                        console.log('👋 Server welcome:', data.message);
                        this.sessionId = data.sessionId;
                        break;
                        
                    case 'subscribed':
                        console.log(`✅ Subscribed to ${data.channel}: ${data.viewers} viewers`);
                        this.updateViewerCount(data.viewers);
                        break;
                        
                    case 'channel_viewers':
                        if (data.channelId === this.currentChannelId) {
                            this.updateViewerCount(data.count);
                        }
                        break;
                        
                    case 'viewer_count':
                        if (data.channelId === this.currentChannelId) {
                            this.updateViewerCount(data.count);
                        }
                        break;
                        
                    case 'live_event':
                        this.showLiveEventNotification(data.message);
                        break;
                        
                    case 'pong':
                        // Server is alive
                        break;
                        
                    case 'stats':
                        console.log('📊 Server stats:', data);
                        break;
                }
            },
            
            // Subscribe to a channel
            subscribeToChannel(channel) {
                if (!this.isConnected || !this.wsConnection || this.wsConnection.readyState !== WebSocket.OPEN) {
                    console.log('⚠️ Not connected to server, cannot subscribe');
                    return;
                }
        
                // Unsubscribe from previous channel if any
                if (this.currentChannelId) {
                    this.unsubscribeFromChannel(this.currentChannelId);
                }
        
                // Get channel name
                const channelName = channel.name || channel;
                this.currentChannelId = this.getChannelId(channelName);
        
                const message = {
                    type: 'subscribe',
                    channel: channelName,
                    channelId: this.currentChannelId
                };
        
                this.wsConnection.send(JSON.stringify(message));
                console.log(`📡 Subscribing to channel: ${this.currentChannelId}`);
            },
            
            // Unsubscribe from a channel
            unsubscribeFromChannel(channelName) {
                if (!this.isConnected || !this.wsConnection || !this.currentChannelId) return;
                
                const message = {
                    type: 'unsubscribe',
                    channel: channelName,
                    channelId: this.currentChannelId
                };
                
                this.wsConnection.send(JSON.stringify(message));
                console.log(`📡 Unsubscribing from channel: ${this.currentChannelId}`);
            },
            
            // Get channel ID
            getChannelId(channel) {
                if (typeof channel === 'string') {
                    return channel.toLowerCase().replace(/[^a-z0-9]/g, '_');
                }
                return channel.name.toLowerCase().replace(/[^a-z0-9]/g, '_');
            },
            
            // Update viewer count with animation
            updateViewerCount(newCount) {
                const oldCount = this.currentViewers;
                this.currentViewers = newCount;
                
                const viewerCountEl = document.getElementById('viewerCount');
                
                // Add animation class
                viewerCountEl.classList.add('counting');
                
                // Smooth count animation for large changes
                if (Math.abs(newCount - oldCount) > 5) {
                    this.animateCountChange(oldCount, newCount, viewerCountEl);
                } else {
                    viewerCountEl.textContent = this.formatViewerCount(newCount);
                }
                
                // Remove animation class after animation
                setTimeout(() => {
                    viewerCountEl.classList.remove('counting');
                }, 1000);
                
                // Update title with exact count
                document.getElementById('viewerCounter').title = `${this.formatViewerCount(newCount)} live viewers (Connected)`;
                
                console.log(`👥 Real viewers updated: ${oldCount} → ${newCount}`);
            },
            
            // Animate count changes
            animateCountChange(start, end, element) {
                const duration = 500;
                const startTime = Date.now();
                const step = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // Easing function
                    const easeOut = 1 - Math.pow(1 - progress, 3);
                    const current = Math.round(start + (end - start) * easeOut);
                    
                    element.textContent = this.formatViewerCount(current);
                    
                    if (progress < 1) {
                        requestAnimationFrame(step);
                    } else {
                        element.textContent = this.formatViewerCount(end);
                    }
                };
                requestAnimationFrame(step);
            },
            
            // Format viewer count (e.g., 1.2k for 1200)
            formatViewerCount(count) {
                if (count >= 1000000) {
                    return (count / 1000000).toFixed(1) + 'M';
                }
                if (count >= 1000) {
                    return (count / 1000).toFixed(1) + 'k';
                }
                return count.toString();
            },
            
            // Show live event notification
            showLiveEventNotification(message) {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = 'live-event-notification';
                notification.innerHTML = `
                    <i class="fas fa-bolt"></i>
                    <span>${message}</span>
                `;
                
                // Add to player area
                const playerArea = document.querySelector('.player-area');
                playerArea.appendChild(notification);
                
                // Remove after 5 seconds
                setTimeout(() => {
                    notification.classList.add('fade-out');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 500);
                }, 5000);
            },
            
            // Handle channel change
            onChannelChange(newChannel) {
                if (!this.isConnected) {
                    console.log('⚠️ Not connected to server, cannot update channel');
                    return;
                }
                
                this.subscribeToChannel(newChannel);
            },
            
            // Start heartbeat to keep connection alive
            startHeartbeat() {
                this.heartbeatInterval = setInterval(() => {
                    if (this.isConnected && this.wsConnection && this.wsConnection.readyState === WebSocket.OPEN) {
                        this.wsConnection.send(JSON.stringify({
                            type: 'ping',
                            timestamp: Date.now()
                        }));
                    }
                }, 30000); // Every 30 seconds
            },
            
            // Attempt to reconnect
            attemptReconnect() {
                if (this.reconnectAttempts >= this.maxReconnectAttempts) {
                    console.error('❌ Max reconnection attempts reached');
                    document.getElementById('viewerCounter').title = 'Live Viewers (Offline)';
                    return;
                }
                
                this.reconnectAttempts++;
                const delay = this.reconnectDelay * Math.pow(1.5, this.reconnectAttempts - 1);
                
                console.log(`🔄 Attempting to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts}) in ${delay}ms`);
                
                setTimeout(() => {
                    this.connectWebSocket();
                }, delay);
            },
            
            // Get current viewer count for a channel
            getViewerCount(channelName) {
                if (!this.isConnected || !this.wsConnection) return;
                
                const message = {
                    type: 'get_viewers',
                    channel: channelName
                };
                
                this.wsConnection.send(JSON.stringify(message));
            },
            
            // Cleanup
            destroy() {
                if (this.heartbeatInterval) {
                    clearInterval(this.heartbeatInterval);
                }
                
                if (this.wsConnection && this.wsConnection.readyState === WebSocket.OPEN) {
                    // Unsubscribe from current channel
                    if (this.currentChannelId) {
                        this.unsubscribeFromChannel(this.currentChannelId);
                    }
                    
                    this.wsConnection.close();
                }
                
                console.log('👥 Viewer Counter System Destroyed');
            }
        };

        // ==================== FIXED BUFFER SYSTEM ====================
        const SimpleBuffer = {
            targetBufferSeconds: 10,
            isBuffering: false,
            bufferTimer: null,
            currentBufferSeconds: 0,
            bufferTimeout: null,
            
            init() {
                console.log('🔄 Simple Buffer System Initialized');
            },
            
            start(channel) {
                if (!channel || !channel.url) return false;
                
                console.log(`🚀 Starting buffer for: ${channel.name}`);
                
                // Stop any existing buffer
                this.stop();
                
                // Reset state
                this.isBuffering = true;
                this.currentBufferSeconds = 0;
                
                // Update UI
                this.showBufferUI(true, `Buffering ${this.targetBufferSeconds}s...`);
                this.updateBufferStatus('Buffering');
                
                // Clear video source first
                videoPlayer.src = '';
                videoPlayer.load();
                
                // Set video source
                videoPlayer.src = channel.url;
                videoPlayer.crossOrigin = "anonymous";
                videoPlayer.preload = "auto";
                
                // Load the video
                videoPlayer.load();
                
                // Set timeout to auto-hide buffering overlay after 4 seconds
                clearTimeout(this.bufferTimeout);
                this.bufferTimeout = setTimeout(() => {
                    this.showBufferUI(false);
                }, 4000);
                
                // Start buffer monitoring
                this.startBufferMonitoring();
                
                // Try to play immediately with autoplay
                this.tryAutoPlay();
                
                return true;
            },
            
            tryAutoPlay() {
                // Try to auto-play after a short delay
                setTimeout(() => {
                    videoPlayer.play().then(() => {
                        console.log('▶️ Auto-play successful');
                        this.isBuffering = false;
                        this.showBufferUI(false);
                        state.isPlaying = true;
                        updatePlayPauseButton();
                        this.updateBufferStatus('Playing');
                        document.getElementById('streamStatus').textContent = 'Live';
                        document.getElementById('streamStatus').style.color = '#4CAF50';
                    }).catch(error => {
                        console.log('⚠️ Auto-play blocked, waiting for user interaction');
                        // Auto-play was blocked, we'll wait for user to click play
                    });
                }, 1000);
            },
            
            startBufferMonitoring() {
                // Clear any existing timer
                if (this.bufferTimer) clearInterval(this.bufferTimer);
                
                let bufferStartTime = Date.now();
                let hasVideoData = false;
                
                this.bufferTimer = setInterval(() => {
                    const elapsed = (Date.now() - bufferStartTime) / 1000;
                    
                    // Calculate actual buffer from video element
                    if (videoPlayer.buffered.length > 0) {
                        const bufferEnd = videoPlayer.buffered.end(videoPlayer.buffered.length - 1);
                        this.currentBufferSeconds = bufferEnd - videoPlayer.currentTime;
                        hasVideoData = true;
                        
                        // Calculate progress based on actual buffer
                        const bufferProgress = Math.min(this.currentBufferSeconds / this.targetBufferSeconds, 1);
                        const progressPercent = Math.round(bufferProgress * 100);
                        
                        document.getElementById('bufferingProgressFill').style.width = `${progressPercent}%`;
                        document.getElementById('bufferingTimer').textContent = 
                            `Buffer: ${this.currentBufferSeconds.toFixed(1)}/${this.targetBufferSeconds}s`;
                        
                        document.getElementById('currentBufferTime').textContent = `${this.currentBufferSeconds.toFixed(1)}s`;
                        document.getElementById('bufferProgress').textContent = `${progressPercent}%`;
                        document.getElementById('bufferTime').textContent = `${this.currentBufferSeconds.toFixed(1)}s`;
                        document.getElementById('currentBuffer').textContent = `${this.currentBufferSeconds.toFixed(1)}s`;
                        
                        // Check if we have enough buffer
                        if (this.currentBufferSeconds >= this.targetBufferSeconds) {
                            this.complete();
                        }
                    } else {
                        // Fallback to time-based progress
                        const bufferProgress = Math.min(elapsed / this.targetBufferSeconds, 1);
                        const progressPercent = Math.round(bufferProgress * 100);
                        
                        document.getElementById('bufferingProgressFill').style.width = `${progressPercent}%`;
                        document.getElementById('bufferingTimer').textContent = 
                            `Loading: ${elapsed.toFixed(1)}/${this.targetBufferSeconds}s`;
                        
                        // If it's taking too long, try to play anyway
                        if (elapsed >= Math.min(this.targetBufferSeconds, 5)) {
                            this.complete();
                        }
                    }
                }, 500);
                
                // Add video event listeners
                const loadedDataHandler = this.handleLoadedData.bind(this);
                const canPlayHandler = this.handleCanPlay.bind(this);
                const videoErrorHandler = this.handleVideoError.bind(this);
                const playingHandler = this.handlePlaying.bind(this);
                
                videoPlayer.addEventListener('loadeddata', loadedDataHandler);
                videoPlayer.addEventListener('canplay', canPlayHandler);
                videoPlayer.addEventListener('error', videoErrorHandler);
                videoPlayer.addEventListener('playing', playingHandler);
                
                // Store handlers for cleanup
                this.eventHandlers = {
                    loadeddata: loadedDataHandler,
                    canplay: canPlayHandler,
                    error: videoErrorHandler,
                    playing: playingHandler
                };
            },
            
            handleLoadedData() {
                console.log('✅ Video data loaded');
                // If we have video data, we can complete faster
                if (videoPlayer.videoWidth > 0) {
                    this.complete();
                }
            },
            
            handleCanPlay() {
                console.log('✅ Video can play');
                this.complete();
            },
            
            handleVideoError() {
                console.error('❌ Video error:', videoPlayer.error);
                this.showBufferUI(false);
                this.updateBufferStatus('Error');
                document.getElementById('streamStatus').textContent = 'Error';
                document.getElementById('streamStatus').style.color = '#F44336';
                
                // Try direct play without buffer
                if (state.currentChannelIndex >= 0) {
                    const channel = state.filteredChannels[state.currentChannelIndex];
                    this.directPlay(channel);
                }
            },
            
            handlePlaying() {
                console.log('▶️ Video started playing');
                this.isBuffering = false;
                this.showBufferUI(false);
                this.updateBufferStatus('Playing');
            },
            
            directPlay(channel) {
                console.log('🔄 Trying direct play...');
                this.showBufferUI(true, 'Trying direct playback...');
                
                videoPlayer.src = channel.url;
                videoPlayer.crossOrigin = "anonymous";
                videoPlayer.preload = "auto";
                
                // Try to play immediately
                videoPlayer.play().then(() => {
                    console.log('✅ Direct play successful');
                    this.isBuffering = false;
                    this.showBufferUI(false);
                    state.isPlaying = true;
                    updatePlayPauseButton();
                    document.getElementById('streamStatus').textContent = 'Live';
                    document.getElementById('streamStatus').style.color = '#4CAF50';
                }).catch(error => {
                    console.error('❌ Direct play failed:', error);
                    this.showBufferUI(false);
                });
            },
            
            complete() {
                if (!this.isBuffering) return;
                
                console.log(`✅ Buffer complete, trying to play...`);
                
                this.isBuffering = false;
                clearInterval(this.bufferTimer);
                clearTimeout(this.bufferTimeout);
                
                // Remove event listeners
                if (this.eventHandlers) {
                    videoPlayer.removeEventListener('loadeddata', this.eventHandlers.loadeddata);
                    videoPlayer.removeEventListener('canplay', this.eventHandlers.canplay);
                    videoPlayer.removeEventListener('error', this.eventHandlers.error);
                    videoPlayer.removeEventListener('playing', this.eventHandlers.playing);
                }
                
                // Try to play
                videoPlayer.play().then(() => {
                    console.log('▶️ Playback started successfully');
                    this.showBufferUI(false);
                    this.updateBufferStatus('Playing');
                    state.isPlaying = true;
                    updatePlayPauseButton();
                    document.getElementById('streamStatus').textContent = 'Live';
                    document.getElementById('streamStatus').style.color = '#4CAF50';
                    
                }).catch(error => {
                    console.error('❌ Play failed, trying fallback:', error);
                    // If play fails, just hide buffer and let user click play
                    this.showBufferUI(false);
                    this.updateBufferStatus('Ready');
                });
            },
            
            showBufferUI(show, text = null) {
                const bufferingOverlay = document.getElementById('bufferingOverlay');
                const bufferingText = document.getElementById('bufferingText');
                
                if (show) {
                    bufferingOverlay.classList.add('active');
                    if (text) {
                        bufferingText.textContent = text;
                    }
                    document.getElementById('streamStatus').textContent = 'Buffering';
                    document.getElementById('streamStatus').style.color = '#FF9800';
                } else {
                    bufferingOverlay.classList.remove('active');
                }
            },
            
            updateBufferStatus(status) {
                const bufferStatusEl = document.getElementById('bufferStatus');
                bufferStatusEl.textContent = status;
                
                switch(status) {
                    case 'Buffering':
                        bufferStatusEl.style.color = '#FF9800';
                        break;
                    case 'Playing':
                        bufferStatusEl.style.color = '#4CAF50';
                        break;
                    case 'Ready':
                        bufferStatusEl.style.color = '#2196F3';
                        break;
                    case 'Error':
                        bufferStatusEl.style.color = '#F44336';
                        break;
                    default:
                        bufferStatusEl.style.color = '#aaa';
                }
            },
            
            stop() {
                this.isBuffering = false;
                if (this.bufferTimer) {
                    clearInterval(this.bufferTimer);
                    this.bufferTimer = null;
                }
                if (this.bufferTimeout) {
                    clearTimeout(this.bufferTimeout);
                    this.bufferTimeout = null;
                }
                this.showBufferUI(false);
                console.log('🛑 Buffer system stopped');
            },
            
            setBufferSeconds(seconds) {
                this.targetBufferSeconds = Math.max(3, Math.min(30, parseInt(seconds)));
                console.log(`⚡ Buffer set to ${this.targetBufferSeconds} seconds`);
                document.getElementById('targetBuffer').textContent = `${this.targetBufferSeconds}s`;
                
                // Update active button
                document.querySelectorAll('.buffer-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (parseInt(btn.dataset.buffer) === this.targetBufferSeconds) {
                        btn.classList.add('active');
                    }
                });
            },
            
            manualBuffer() {
                if (state.currentChannelIndex >= 0) {
                    const channel = state.filteredChannels[state.currentChannelIndex];
                    this.showBufferUI(true, 'Manual buffer...');
                    this.start(channel);
                }
            }
        };

        // ==================== APP STATE ====================
        const state = {
            channels: [],
            filteredChannels: [],
            currentChannelIndex: 0,
            isPlaying: false,
            volume: 0.75,
            isMuted: false,
            isFullscreen: false,
            showOverlay: false,
            showInfoPanel: true,
            overlayTimeout: null,
            categories: {},
            currentPlaylistUrl: 'https://gist.githubusercontent.com/RalphDarbouze/7fc242ebfecbba4f6854becb8b8abc94/raw/784008ecd0cb44c88bd88944b10dee4315fee379/my_first_iptv.m3u',
        };

        // ==================== DOM ELEMENTS ====================
        const loadingScreen = document.getElementById('loadingScreen');
        const appContainer = document.getElementById('appContainer');
        const videoPlayer = document.getElementById('video-player');
        const channelList = document.getElementById('channelList');
        const channelSearch = document.getElementById('channel-search');
        const channelCount = document.getElementById('channelCount');
        const currentTimeEl = document.getElementById('currentTime');
        const playPauseBtn = document.getElementById('playPause');
        const playIcon = document.getElementById('playIcon');
        const prevChannelBtn = document.getElementById('prevChannel');
        const nextChannelBtn = document.getElementById('nextChannel');
        const manualBufferBtn = document.getElementById('manualBufferBtn');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeIcon = document.getElementById('volumeIcon');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const playerOverlay = document.getElementById('playerOverlay');
        const channelSidebar = document.getElementById('channelSidebar');
        const infoPanel = document.getElementById('infoPanel');
        const overlayChannelName = document.getElementById('overlayChannelName');
        const overlayChannelGroup = document.getElementById('overlayChannelGroup');
        const nowPlayingLogo = document.getElementById('nowPlayingLogo');
        const nowPlayingName = document.getElementById('nowPlayingName');
        const nowPlayingGroup = document.getElementById('nowPlayingGroup');
        const streamStatus = document.getElementById('streamStatus');
        const currentTimeDisplay = document.getElementById('currentTimeDisplay');
        const durationDisplay = document.getElementById('durationDisplay');
        const progressFill = document.getElementById('progressFill');

        // ==================== APP INITIALIZATION ====================
        function initApp() {
            updateClock();
            setInterval(updateClock, 60000);
            
            setupEventListeners();
            loadPlaylist();
            setupKeyboardNavigation();
            setInitialVolume();
            
            // Initialize simple buffer system
            SimpleBuffer.init();
            
            // Initialize REAL viewer counter
            RealViewerCounter.init();
            
            hideInfoPanelWithDelay();
            
            // Setup video event listeners
            setupVideoListeners();
            
            // Test network speed
            testNetworkSpeed();
        }

        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            currentTimeEl.textContent = timeString;
        }

        // ==================== NETWORK SPEED TEST ====================
        async function testNetworkSpeed() {
            try {
                const startTime = Date.now();
                const response = await fetch('https://source.unsplash.com/random/100x100');
                const endTime = Date.now();
                
                if (response.ok) {
                    const contentLength = response.headers.get('content-length');
                    if (contentLength) {
                        const fileSizeKB = parseInt(contentLength) / 1024;
                        const durationSeconds = (endTime - startTime) / 1000;
                        const speedMbps = (fileSizeKB * 8) / (durationSeconds * 1024);
                        
                        document.getElementById('networkSpeed').textContent = `${speedMbps.toFixed(1)} Mbps`;
                        document.getElementById('liveNetworkSpeed').textContent = `${speedMbps.toFixed(1)} Mbps`;
                        document.getElementById('performanceSpeed').textContent = `${speedMbps.toFixed(1)} Mbps`;
                        
                        // Adjust buffer based on speed
                        if (speedMbps < 2) {
                            SimpleBuffer.setBufferSeconds(20);
                        } else if (speedMbps < 5) {
                            SimpleBuffer.setBufferSeconds(15);
                        } else if (speedMbps < 10) {
                            SimpleBuffer.setBufferSeconds(10);
                        } else {
                            SimpleBuffer.setBufferSeconds(5);
                        }
                    }
                }
            } catch (error) {
                console.log('Network speed test failed:', error);
                document.getElementById('networkSpeed').textContent = 'Unknown';
                document.getElementById('liveNetworkSpeed').textContent = 'Unknown';
                document.getElementById('performanceSpeed').textContent = 'Unknown';
            }
        }

        // ==================== PLAYLIST LOADING ====================
        async function loadPlaylist() {
            try {
                const response = await fetch(state.currentPlaylistUrl);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch playlist: ${response.status}`);
                }
                
                const playlistText = await response.text();
                parsePlaylist(playlistText);
                
            } catch (error) {
                console.error('Error loading playlist:', error);
                loadDemoChannels();
            }
        }

        function parsePlaylist(playlistText) {
            const lines = playlistText.split('\n');
            const channels = [];
            let currentChannel = null;
            let channelNumber = 1;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line.startsWith('#EXTINF:')) {
                    const match = line.match(/#EXTINF:(-?\d+)\s*(.*?),(.*)/);
                    if (match) {
                        const [_, duration, attributes, name] = match;
                        const groupMatch = attributes.match(/group-title="([^"]+)"/);
                        const logoMatch = attributes.match(/tvg-logo="([^"]+)"/);
                        const idMatch = attributes.match(/tvg-id="([^"]+)"/);
                        
                        currentChannel = {
                            name: name.trim(),
                            group: groupMatch ? groupMatch[1] : 'General',
                            logo: logoMatch ? logoMatch[1] : null,
                            tvgId: idMatch ? idMatch[1] : null,
                            url: null,
                            number: channelNumber++
                        };
                    }
                } 
                else if (line && !line.startsWith('#') && currentChannel) {
                    currentChannel.url = line;
                    channels.push(currentChannel);
                    
                    if (!state.categories[currentChannel.group]) {
                        state.categories[currentChannel.group] = [];
                    }
                    state.categories[currentChannel.group].push(currentChannel);
                    
                    currentChannel = null;
                }
            }

            if (channels.length > 0) {
                state.channels = channels;
                state.filteredChannels = [...channels];
                channelCount.textContent = channels.length;
                renderChannelList();
                showApp();
                setTimeout(() => selectChannel(0), 100);
            } else {
                loadDemoChannels();
            }
        }

        function loadDemoChannels() {
            const demoChannels = [
                { name: "BBC World News", group: "News", logo: null, url: "https://sample-videos.com/video123/mp4/720/big_buck_bunny_720p_1mb.mp4", number: 1 },
                { name: "CNN International", group: "News", logo: null, url: "https://sample-videos.com/video123/mp4/720/big_buck_bunny_720p_2mb.mp4", number: 2 },
                { name: "ESPN HD", group: "Sports", logo: null, url: "https://sample-videos.com/video123/mp4/720/big_buck_bunny_720p_5mb.mp4", number: 3 },
                { name: "HBO HD", group: "Entertainment", logo: null, url: "https://sample-videos.com/video123/mp4/480/big_buck_bunny_480p_1mb.mp4", number: 4 },
            ];
            
            state.channels = demoChannels;
            state.filteredChannels = [...demoChannels];
            
            demoChannels.forEach(channel => {
                if (!state.categories[channel.group]) {
                    state.categories[channel.group] = [];
                }
                state.categories[channel.group].push(channel);
            });
            
            channelCount.textContent = demoChannels.length;
            renderChannelList();
            showApp();
            setTimeout(() => selectChannel(0), 100);
        }

        // ==================== CHANNEL MANAGEMENT ====================
        function renderChannelList() {
            channelList.innerHTML = '';
            
            const allChannelsCategory = document.createElement('div');
            allChannelsCategory.className = 'channel-category';
            allChannelsCategory.innerHTML = `<div class="category-title">ALL CHANNELS</div>`;
            
            state.filteredChannels.forEach((channel, index) => {
                const channelElement = createChannelElement(channel, index, 'all');
                allChannelsCategory.appendChild(channelElement);
            });
            
            channelList.appendChild(allChannelsCategory);
            
            for (const [categoryName, categoryChannels] of Object.entries(state.categories)) {
                const filteredCategoryChannels = categoryChannels.filter(channel => 
                    state.filteredChannels.includes(channel)
                );
                
                if (filteredCategoryChannels.length > 0) {
                    const categoryElement = document.createElement('div');
                    categoryElement.className = 'channel-category';
                    
                    const categoryClass = categoryName.toLowerCase().replace(/\s+/g, '-');
                    
                    categoryElement.innerHTML = `
                        <div class="category-title category-${categoryClass}">${categoryName.toUpperCase()}</div>
                    `;
                    
                    filteredCategoryChannels.forEach(channel => {
                        const index = state.filteredChannels.findIndex(c => c.name === channel.name);
                        if (index !== -1) {
                            const channelElement = createChannelElement(channel, index, categoryClass);
                            categoryElement.appendChild(channelElement);
                        }
                    });
                    
                    channelList.appendChild(categoryElement);
                }
            }
        }

        function createChannelElement(channel, index, categoryClass) {
            const channelElement = document.createElement('div');
            channelElement.className = `channel-item ${index === state.currentChannelIndex ? 'active' : ''}`;
            channelElement.tabIndex = 0;
            channelElement.dataset.index = index;
            channelElement.dataset.number = channel.number;
            
            const logoText = getChannelInitials(channel.name);
            const logoColor = stringToColor(channel.name);
            
            channelElement.innerHTML = `
                <div class="channel-logo" style="background: ${logoColor}">
                    ${logoText}
                </div>
                <div class="channel-info">
                    <div class="channel-name">${channel.name}</div>
                    <div class="channel-number">${channel.number.toString().padStart(3, '0')}</div>
                </div>
                <div class="channel-playing">
                    <i class="fas fa-play"></i>
                </div>
            `;
            
            channelElement.addEventListener('click', () => {
                selectChannel(index);
                resetOverlayTimer();
            });
            
            channelElement.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    selectChannel(index);
                    resetOverlayTimer();
                }
            });
            
            return channelElement;
        }

        function getChannelInitials(name) {
            return name
                .split(' ')
                .map(word => word.charAt(0).toUpperCase())
                .slice(0, 2)
                .join('');
        }

        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            const hue = hash % 360;
            return `hsl(${hue}, 70%, 50%)`;
        }

        // ==================== CHANNEL SELECTION ====================
        function selectChannel(index) {
            if (index < 0 || index >= state.filteredChannels.length) return;
            
            const channel = state.filteredChannels[index];
            state.currentChannelIndex = index;
            
            // Notify REAL viewer counter of channel change
            RealViewerCounter.onChannelChange(channel);
            
            // Update channel selection UI
            document.querySelectorAll('.channel-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const selectedElement = channelList.querySelector(`[data-index="${index}"]`);
            if (selectedElement) {
                selectedElement.classList.add('active');
                selectedElement.focus();
                selectedElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            // Update UI
            overlayChannelName.textContent = channel.name;
            overlayChannelGroup.textContent = channel.group;
            nowPlayingName.textContent = channel.name;
            nowPlayingGroup.textContent = channel.group;
            
            const logoText = getChannelInitials(channel.name);
            const logoColor = stringToColor(channel.name);
            nowPlayingLogo.innerHTML = logoText;
            nowPlayingLogo.style.background = logoColor;
            
            showOverlay();
            resetOverlayTimer();
            
            // Start buffering with auto-play
            SimpleBuffer.start(channel);
        }

        function navigateChannels(direction) {
            let newIndex = state.currentChannelIndex + direction;
            
            if (newIndex < 0) {
                newIndex = state.filteredChannels.length - 1;
            } else if (newIndex >= state.filteredChannels.length) {
                newIndex = 0;
            }
            
            selectChannel(newIndex);
        }

        // ==================== NUMBER CHANNEL SEARCH ====================
        function findChannelByNumber(numberStr) {
            // Remove leading zeros and convert to number
            const channelNumber = parseInt(numberStr.replace(/^0+/, ''));
            
            if (isNaN(channelNumber)) return -1;
            
            // Try exact match first
            let index = state.filteredChannels.findIndex(channel => channel.number === channelNumber);
            
            // If not found, try with leading zeros (up to 5 digits)
            if (index === -1) {
                for (let i = 0; i < state.filteredChannels.length; i++) {
                    const channel = state.filteredChannels[i];
                    const channelNumStr = channel.number.toString();
                    const paddedNumber = channelNumber.toString();
                    
                    // Match with different padding lengths (up to 5 digits)
                    if (channelNumStr === paddedNumber || 
                        channelNumStr === paddedNumber.padStart(2, '0') ||
                        channelNumStr === paddedNumber.padStart(3, '0') ||
                        channelNumStr === paddedNumber.padStart(4, '0') ||
                        channelNumStr === paddedNumber.padStart(5, '0')) {
                        index = i;
                        break;
                    }
                }
            }
            
            return index;
        }

        // ==================== PLAYER CONTROLS ====================
        function togglePlayPause() {
            if (!videoPlayer.src) return;
            
            if (videoPlayer.paused) {
                videoPlayer.play().then(() => {
                    state.isPlaying = true;
                    updatePlayPauseButton();
                    streamStatus.textContent = 'Live';
                    streamStatus.style.color = '#4CAF50';
                    SimpleBuffer.updateBufferStatus('Playing');
                }).catch(error => {
                    console.error('Play failed:', error);
                    // Try to buffer and play
                    const channel = state.filteredChannels[state.currentChannelIndex];
                    SimpleBuffer.start(channel);
                });
            } else {
                videoPlayer.pause();
                state.isPlaying = false;
                updatePlayPauseButton();
                streamStatus.textContent = 'Paused';
                streamStatus.style.color = '#FF9800';
                SimpleBuffer.updateBufferStatus('Paused');
            }
            resetOverlayTimer();
        }

        function updatePlayPauseButton() {
            if (state.isPlaying) {
                playIcon.className = 'fas fa-pause';
            } else {
                playIcon.className = 'fas fa-play';
            }
        }

        function setInitialVolume() {
            videoPlayer.volume = state.volume;
            volumeSlider.value = state.volume;
            updateVolumeIcon();
        }

        function updateVolumeIcon() {
            if (state.volume === 0) {
                volumeIcon.className = 'fas fa-volume-off';
            } else if (state.volume < 0.5) {
                volumeIcon.className = 'fas fa-volume-down';
            } else {
                volumeIcon.className = 'fas fa-volume-up';
            }
        }

        // ==================== FULLSCREEN - FIXED ====================
        function toggleFullscreen() {
            if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement && !document.msFullscreenElement) {
                // Enter fullscreen
                const elem = document.documentElement;
                
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.mozRequestFullScreen) {
                    elem.mozRequestFullScreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                }
                
            } else {
                // Exit fullscreen
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
            
            resetOverlayTimer();
        }

        function handleFullscreenChange() {
            const isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement);
            
            state.isFullscreen = isFullscreen;
            document.body.classList.toggle('fullscreen-mode', isFullscreen);
            
            // Update fullscreen button icon
            if (isFullscreen) {
                fullscreenBtn.querySelector('.fullscreen-in').style.display = 'none';
                fullscreenBtn.querySelector('.fullscreen-out').style.display = 'block';
                videoPlayer.style.objectFit = 'contain';
            } else {
                fullscreenBtn.querySelector('.fullscreen-in').style.display = 'block';
                fullscreenBtn.querySelector('.fullscreen-out').style.display = 'none';
                videoPlayer.style.objectFit = 'contain';
            }
            
            // Show overlay when entering fullscreen
            if (isFullscreen) {
                showOverlay();
                resetOverlayTimer();
            }
        }

        // ==================== UI CONTROLS ====================
        function showOverlay() {
            playerOverlay.classList.add('active');
            playerOverlay.classList.remove('hide-overlay');
            state.showOverlay = true;
            
            // Show buffer stats in fullscreen
            if (state.isFullscreen) {
                document.getElementById('bufferStats').style.display = 'block';
            }
        }

        function hideOverlay() {
            playerOverlay.classList.add('hide-overlay');
            setTimeout(() => {
                playerOverlay.classList.remove('active');
            }, 500);
            state.showOverlay = false;
            
            // Hide buffer stats when overlay hides
            if (state.isFullscreen) {
                document.getElementById('bufferStats').style.display = 'none';
            }
        }

        function resetOverlayTimer() {
            clearTimeout(state.overlayTimeout);
            showOverlay();
            state.overlayTimeout = setTimeout(hideOverlay, 3000);
        }

        function hideInfoPanelWithDelay() {
            setTimeout(() => {
                infoPanel.classList.add('hidden');
                state.showInfoPanel = false;
            }, 10000);
        }

        function toggleInfoPanel() {
            if (state.showInfoPanel) {
                infoPanel.classList.add('hidden');
                state.showInfoPanel = false;
            } else {
                infoPanel.classList.remove('hidden');
                state.showInfoPanel = true;
            }
        }

        function filterChannels() {
            const searchTerm = channelSearch.value.toLowerCase();
            
            if (!searchTerm) {
                state.filteredChannels = [...state.channels];
            } else {
                // Check if search is a number (up to 5 digits)
                const isNumber = /^\d{1,5}$/.test(searchTerm);
                
                if (isNumber) {
                    // Find channel by number
                    const channelIndex = findChannelByNumber(searchTerm);
                    if (channelIndex !== -1) {
                        selectChannel(channelIndex);
                        channelSearch.value = ''; // Clear search
                        return;
                    }
                }
                
                // Regular text search
                state.filteredChannels = state.channels.filter(channel => 
                    channel.name.toLowerCase().includes(searchTerm) || 
                    (channel.group && channel.group.toLowerCase().includes(searchTerm)) ||
                    channel.number.toString().includes(searchTerm)
                );
            }
            
            renderChannelList();
            if (state.filteredChannels.length > 0) {
                if (state.currentChannelIndex >= state.filteredChannels.length) {
                    state.currentChannelIndex = 0;
                }
                // Don't auto-select when searching
            }
        }

        function showApp() {
            loadingScreen.style.display = 'none';
            appContainer.style.display = 'flex';
        }

        // ==================== VIDEO LISTENERS ====================
        function setupVideoListeners() {
            // Track video progress
            videoPlayer.addEventListener('timeupdate', updateTimeDisplay);
            videoPlayer.addEventListener('loadedmetadata', () => {
                durationDisplay.textContent = formatTime(videoPlayer.duration);
            });
            
            videoPlayer.addEventListener('timeupdate', () => {
                if (videoPlayer.duration) {
                    const progress = (videoPlayer.currentTime / videoPlayer.duration) * 100;
                    progressFill.style.width = `${progress}%`;
                }
            });
            
            // Update buffer stats when video progresses
            videoPlayer.addEventListener('progress', () => {
                if (videoPlayer.buffered.length > 0) {
                    const bufferEnd = videoPlayer.buffered.end(videoPlayer.buffered.length - 1);
                    const bufferSeconds = bufferEnd - videoPlayer.currentTime;
                    
                    // Update buffer display
                    document.getElementById('currentBufferTime').textContent = `${bufferSeconds.toFixed(1)}s`;
                    document.getElementById('bufferTime').textContent = `${bufferSeconds.toFixed(1)}s`;
                    document.getElementById('currentBuffer').textContent = `${bufferSeconds.toFixed(1)}s`;
                    
                    const bufferPercent = Math.round((bufferSeconds / SimpleBuffer.targetBufferSeconds) * 100);
                    document.getElementById('bufferProgress').textContent = `${bufferPercent}%`;
                    
                    // Update buffer size estimate (rough calculation)
                    const bitrate = 2000; // Assume 2 Mbps average
                    const bufferSizeMB = (bufferSeconds * bitrate / 8) / 1000;
                    document.getElementById('bufferSize').textContent = `${bufferSizeMB.toFixed(1)} MB`;
                    document.getElementById('bitrate').textContent = `${bitrate} kbps`;
                }
            });
            
            // Handle video events
            videoPlayer.addEventListener('play', () => {
                state.isPlaying = true;
                updatePlayPauseButton();
                streamStatus.textContent = 'Live';
                streamStatus.style.color = '#4CAF50';
                SimpleBuffer.updateBufferStatus('Playing');
            });
            
            videoPlayer.addEventListener('pause', () => {
                state.isPlaying = false;
                updatePlayPauseButton();
                streamStatus.textContent = 'Paused';
                streamStatus.style.color = '#FF9800';
                SimpleBuffer.updateBufferStatus('Paused');
            });
            
            videoPlayer.addEventListener('waiting', () => {
                if (!SimpleBuffer.isBuffering) {
                    SimpleBuffer.showBufferUI(true, 'Buffering...');
                    SimpleBuffer.updateBufferStatus('Buffering');
                }
            });
            
            videoPlayer.addEventListener('playing', () => {
                SimpleBuffer.showBufferUI(false);
                SimpleBuffer.updateBufferStatus('Playing');
            });
            
            videoPlayer.addEventListener('volumechange', () => {
                state.volume = videoPlayer.volume;
                volumeSlider.value = state.volume;
                updateVolumeIcon();
            });
        }

        function updateTimeDisplay() {
            currentTimeDisplay.textContent = formatTime(videoPlayer.currentTime);
            if (!isNaN(videoPlayer.duration)) {
                durationDisplay.textContent = formatTime(videoPlayer.duration);
            }
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // ==================== KEYBOARD CONTROLS ====================
        function setupKeyboardNavigation() {
            document.addEventListener('keydown', (e) => {
                // Fullscreen
                if (e.key === 'f' || e.key === 'F') {
                    e.preventDefault();
                    toggleFullscreen();
                }
                
                // Manual buffer
                if (e.key === 'b' || e.key === 'B') {
                    e.preventDefault();
                    SimpleBuffer.manualBuffer();
                }
                
                // Buffer presets (1-4)
                if (e.key >= '1' && e.key <= '4') {
                    e.preventDefault();
                    const bufferTimes = [5, 10, 15, 20];
                    const index = parseInt(e.key) - 1;
                    if (index < bufferTimes.length) {
                        SimpleBuffer.setBufferSeconds(bufferTimes[index]);
                    }
                }
                
                // Escape
                if (e.key === 'Escape') {
                    e.preventDefault();
                    if (state.isFullscreen) {
                        toggleFullscreen();
                    } else {
                        toggleInfoPanel();
                    }
                }
                
                // Channel navigation
                if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    navigateChannels(-1);
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    navigateChannels(1);
                }
                
                // Volume control
                else if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    state.volume = Math.max(0, state.volume - 0.1);
                    videoPlayer.volume = state.volume;
                    volumeSlider.value = state.volume;
                    updateVolumeIcon();
                } else if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    state.volume = Math.min(1, state.volume + 0.1);
                    videoPlayer.volume = state.volume;
                    volumeSlider.value = state.volume;
                    updateVolumeIcon();
                }
                
                // Play/Pause
                else if (e.key === ' ' || e.key === 'MediaPlayPause') {
                    e.preventDefault();
                    togglePlayPause();
                }
                
                // Channel selection
                else if (e.key === 'Enter') {
                    const focusedChannel = document.activeElement.closest('.channel-item');
                    if (focusedChannel) {
                        e.preventDefault();
                        const index = parseInt(focusedChannel.dataset.index);
                        selectChannel(index);
                    }
                }
                
                // Number keys for direct channel selection (up to 5 digits)
                if (e.key >= '0' && e.key <= '9') {
                    const currentInput = channelSearch.value;
                    
                    // Check if we're typing a multi-digit number (up to 5 digits)
                    if (/^\d{0,4}$/.test(currentInput) && /^\d$/.test(e.key)) {
                        e.preventDefault();
                        const newInput = currentInput + e.key;
                        
                        // If we have 1-5 digits, search for channel
                        if (newInput.length >= 1 && newInput.length <= 5) {
                            const channelIndex = findChannelByNumber(newInput);
                            if (channelIndex !== -1) {
                                selectChannel(channelIndex);
                                channelSearch.value = ''; // Clear search
                            } else {
                                // Show the number in search bar but don't search yet
                                channelSearch.value = newInput;
                            }
                        }
                    }
                }
                
                // Tab to show/hide panels
                if (e.key === 'Tab' && !e.shiftKey) {
                    e.preventDefault();
                    toggleInfoPanel();
                }
            });
        }

        // ==================== EVENT LISTENERS ====================
        function setupEventListeners() {
            playPauseBtn.addEventListener('click', togglePlayPause);
            prevChannelBtn.addEventListener('click', () => {
                navigateChannels(-1);
                resetOverlayTimer();
            });
            nextChannelBtn.addEventListener('click', () => {
                navigateChannels(1);
                resetOverlayTimer();
            });
            manualBufferBtn.addEventListener('click', () => {
                SimpleBuffer.manualBuffer();
                resetOverlayTimer();
            });
            
            // Fullscreen
            fullscreenBtn.addEventListener('click', toggleFullscreen);
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
            document.addEventListener('mozfullscreenchange', handleFullscreenChange);
            document.addEventListener('MSFullscreenChange', handleFullscreenChange);
            
            // Volume
            volumeSlider.addEventListener('input', (e) => {
                state.volume = parseFloat(e.target.value);
                videoPlayer.volume = state.volume;
                updateVolumeIcon();
            });
            
            // Channel search
            channelSearch.addEventListener('input', filterChannels);
            
            // Buffer buttons
            document.querySelectorAll('.buffer-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const seconds = parseInt(btn.dataset.buffer);
                    SimpleBuffer.setBufferSeconds(seconds);
                });
            });
            
            // Show overlay on interaction
            document.addEventListener('mousemove', () => {
                resetOverlayTimer();
            });
            
            document.addEventListener('touchstart', () => {
                resetOverlayTimer();
            });
        }

        // ==================== INITIALIZE APP ====================
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>



























